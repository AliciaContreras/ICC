{% extends 'laboratorio/base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow border-primary">
            <div class="card-header bg-primary text-white">
                <h4><i class="bi bi-tools"></i> {{ accion }} Invento</h4>
            </div>
            <div class="card-body">
                <!-- IMPORTANTE: enctype agregado para subir archivos -->
                <form method="post" enctype="multipart/form-data" novalidate>
                    {% csrf_token %}
                    
                    <!-- 1. DATOS DEL INVENTO -->
                    <h5 class="text-muted mb-3">Datos Generales</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Nombre</label>
                            {{ form.nombre }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Probabilidad de Éxito</label>
                            <div class="input-group">
                                {{ form.probabilidad_exito }}
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label fw-bold">Descripción</label>
                            {{ form.descripcion }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Fecha Fabricación</label>
                            {{ form.fecha_fabricacion }}
                        </div>
                        <!-- CAMPO DE FOTO -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Fotografía del Prototipo</label>
                            {{ form.foto }}
                        </div>
                    </div>

                    <hr>

                    <!-- 2. GESTIÓN DE COMPONENTES (FORMSET) -->
                    <h5 class="text-muted mb-3">
                        <i class="bi bi-basket"></i> Lista de Materiales (Receta)
                    </h5>
                    
                    {{ formset.management_form }}

                    <div class="table-responsive">
                        <table class="table table-sm table-bordered align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 60%;">Componente</th>
                                    <th style="width: 20%;">Cantidad</th>
                                    <th style="width: 20%;" class="text-center">¿Eliminar?</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for subform in formset %}
                                    <tr>
                                        {% for hidden in subform.hidden_fields %}
                                            {{ hidden }}
                                        {% endfor %}
                                        
                                        <td>
                                            {{ subform.componente }}
                                            {% if subform.componente.errors %}
                                                <div class="text-danger small">{{ subform.componente.errors }}</div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {{ subform.cantidad }}
                                            {% if subform.cantidad.errors %}
                                                <div class="text-danger small">{{ subform.cantidad.errors }}</div>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if subform.instance.pk %}
                                                <div class="form-check d-flex justify-content-center">
                                                    {{ subform.DELETE }}
                                                </div>
                                            {% else %}
                                                <small class="text-muted">Nuevo</small>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="form-text mb-4">
                        * Si dejas el componente vacío, la fila se ignorará.
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-save"></i> Guardar Proyecto Completo
                        </button>
                        <a href="{% url 'lista_inventos' %}" class="btn btn-secondary">Cancelar</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}